# Task 018 Creation - Phase 2a Foundation

**Date**: 2025-12-28
**Time**: 21:02:45
**Agent**: Orchestrator
**Duration**: ~10 minutes

## Summary

Created Task 018 specification file (`agent_tasks/018_pricepoint-marketdataport.md`) for Phase 2a's foundation implementation. This is the first implementation task after Phase 2 architecture completion.

## Task Overview

**Task 018**: PricePoint DTO and MarketDataPort Interface
- **Estimated Duration**: 2-3 hours
- **Agent**: backend-swe
- **Dependencies**: None (foundation layer)
- **Phase**: 2a - Real-time market data integration

## What Was Created

### Task Specification File

**Location**: `agent_tasks/018_pricepoint-marketdataport.md`
**Length**: ~550 lines

**Components Specified**:
1. **PricePoint DTO** (Application layer)
   - Required properties: ticker, price, timestamp, source, interval
   - Optional OHLCV properties: open, high, low, close, volume
   - Methods: `is_stale()`, `with_source()`
   - Comprehensive validation rules and invariants

2. **MarketDataError Exceptions**
   - Base: `MarketDataError`
   - Subclasses: `TickerNotFoundError`, `MarketDataUnavailableError`, `InvalidPriceDataError`

3. **MarketDataPort Protocol** (Application layer port)
   - Methods: `get_current_price()`, `get_price_at()`, `get_price_history()`, `get_supported_tickers()`
   - Full async interface with comprehensive docstrings

4. **InMemoryMarketDataAdapter** (Testing adapter)
   - Implements MarketDataPort for testing
   - Dict-based storage with seed methods
   - Easy test data setup

### Files to be Created by Backend-SWE

**New Code Files** (4):
- `backend/src/papertrade/application/dtos/price_point.py`
- `backend/src/papertrade/application/exceptions.py` (extend existing)
- `backend/src/papertrade/application/ports/market_data_port.py`
- `backend/src/papertrade/adapters/outbound/market_data/in_memory_adapter.py`

**New Test Files** (3):
- `backend/tests/unit/application/dtos/test_price_point.py`
- `backend/tests/unit/application/test_exceptions.py`
- `backend/tests/unit/application/ports/test_market_data_port.py`

## Architectural Decisions

### PricePoint Classification: Application DTO (Not Domain Value Object)

**Reasoning**:
- Stock prices are external facts, not core domain behavior
- Primary use is transferring data between layers
- No complex business logic, mostly validation
- Keeps domain layer pure and focused

**Location**: Application layer (`application/dtos/`)

### Protocol Interface Design

**MarketDataPort** uses `typing.Protocol`:
- Same pattern as existing `PortfolioRepository`
- Enables dependency injection and testing
- Clean separation of interface from implementation
- Follows Clean Architecture port/adapter pattern

## Design Highlights

### Time-Aware Design

All interfaces support historical queries:
- `get_price_at(ticker, timestamp)` - For backtesting (Phase 3)
- `get_price_history(ticker, start, end)` - For charts
- PricePoint includes `interval` and `timestamp` fields

### Source Transparency

`PricePoint.source` indicates data origin:
- "alpha_vantage" - Fresh API data
- "cache" - Redis cached data
- "database" - PostgreSQL historical data

Enables smart caching decisions and freshness checks.

### Staleness Detection

`PricePoint.is_stale(max_age)` method:
- Checks if price is older than threshold
- Enables cache invalidation logic
- Powers "data freshness" indicators in UI

### OHLCV Support

Optional candlestick data (Open, High, Low, Close, Volume):
- Supports future charting features
- Maintains data fidelity from APIs
- Validates OHLCV invariants (low ≤ open/close ≤ high)

## Testing Strategy

### Coverage Targets
- **PricePoint**: 100% (all validation paths, methods, edge cases)
- **Exceptions**: 100% (all types, attributes, inheritance)
- **MarketDataPort**: Protocol compliance + InMemoryAdapter
- **Integration**: End-to-end with InMemoryAdapter

### Key Test Cases
1. PricePoint validation (currency matching, timezone, invariants)
2. `is_stale()` and `with_source()` behavior
3. Exception attributes and messages
4. InMemoryAdapter seeding and retrieval
5. Protocol compliance (type checking)

## Integration Points

### Dependencies (Existing)
- `Ticker` value object (domain layer)
- `Money` value object (domain layer)
- `Currency` enum (domain layer)

### Used By (Future Tasks)
- **Task 019**: AlphaVantageAdapter (implements MarketDataPort)
- **Task 020**: PostgreSQL PriceRepository (stores PricePoint)
- **Task 021**: Portfolio queries (fetch prices via MarketDataPort)
- **Task 022**: Frontend real price display

## Next Steps

1. **Start backend-swe agent** on Task 018
   ```bash
   gh pr create --draft --title "feat: Task 018 - PricePoint and MarketDataPort"
   # Then use Copilot coding agent or manual implementation
   ```

2. **After Task 018 Complete**:
   - Create Task 019: AlphaVantageAdapter + RateLimiter + Cache (6-8 hours)
   - This is the **critical path** for Phase 2a

3. **Parallel Work Opportunity**:
   - While Task 019 is being implemented, could start Task 020 (PostgreSQL schema)
   - Or wait for sequential completion to avoid conflicts

## Architecture Compliance

This task follows **Clean Architecture**:
- ✅ **PricePoint (DTO)**: Application layer, no I/O
- ✅ **MarketDataPort**: Application layer port (interface)
- ✅ **InMemoryAdapter**: Adapters layer (implementation)
- ✅ **Dependency Rule**: Adapters → Application → Domain

## Reference Documents

- **Primary**: `/docs/architecture/20251228_phase2-market-data/interfaces.md`
- **Implementation Guide**: `/docs/architecture/20251228_phase2-market-data/implementation-guide.md`
- **Testing Strategy**: `/docs/architecture/20251228_phase2-market-data/testing-strategy.md`
- **ADR-001**: Caching strategy (3-tier: Redis → PostgreSQL → API)
- **ADR-002**: Rate limiting (token bucket algorithm)
- **ADR-004**: Configuration approach (TOML + Pydantic)

## Success Criteria

- [x] Task 018 specification created and comprehensive
- [x] Committed to main branch
- [x] Pushed to remote
- [ ] Backend-swe agent started
- [ ] PR created for implementation
- [ ] All tests passing
- [ ] Type checking passing (pyright --strict)
- [ ] Code review and merge

## Notes

**Task Numbering**: Original architecture plan proposed Tasks 015-025, but tasks 015-017 already existed, so Phase 2 tasks were renumbered to 018-028.

**Task Consolidation**: Combined original Tasks 015 (PricePoint) and 016 (MarketDataPort) into single Task 018 since they're small, tightly coupled, and form a cohesive unit.

**Time Estimate**: 2-3 hours is achievable because:
- Clear specifications in architecture docs
- Simple data structures (dataclass + Protocol)
- Testing adapter is straightforward
- No external dependencies or I/O
- Familiar patterns (similar to existing value objects and ports)

---

**Status**: ✅ Task specification complete, ready for implementation
