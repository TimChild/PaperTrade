version: "3"

vars:
  BACKEND_DIR: ./backend
  FRONTEND_DIR: ./frontend

tasks:
  setup:
    desc: "Set up complete development environment"
    cmds:
      - task: precommit:install
      - task: setup:backend
      - task: setup:frontend
      - task: docker:up
      - echo "âœ“ Development environment setup complete!"
      - echo "  - Pre-commit hooks installed"
      - echo "  - Backend dependencies installed"
      - echo "  - Frontend dependencies installed (if frontend exists)"
      - echo "  - Docker services started (PostgreSQL, Redis)"
      - echo ""
      - 'echo "Next steps:"'
      - 'echo "  - Run ''task test:all'' to run all tests"'
      - 'echo "  - Run ''task dev:backend'' to start backend server if dev mode"'
      - 'echo "  - Run ''task dev:frontend'' to start frontend server in dev mode"'
      - 'echo "  - OR use ''task docker:up:all'' to run the full app stack"'

  setup:backend:
    desc: "Install backend dependencies"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "Installing backend dependencies with uv..."
      - uv sync --all-extras
      - echo "âœ“ Backend dependencies installed"

  setup:frontend:
    desc: "Install frontend dependencies"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "Installing frontend dependencies with npm..."
      - npm ci
      - echo "âœ“ Frontend dependencies installed"
    status:
      - test -d node_modules

  dev:backend:
    desc: "Start backend development server"
    dir: "{{.BACKEND_DIR}}"
    deps:
      - docker:up
    cmds:
      - 'echo "Starting backend server on http://localhost:8000"'
      - uv run uvicorn zebu.main:app --reload --host 0.0.0.0 --port 8000

  dev:frontend:
    desc: "Start frontend development server"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "Starting frontend dev server..."
      - npm run dev
    preconditions:
      - sh: test -f package.json
        msg: "Frontend not found. Run 'task setup:frontend' first or create frontend directory."

  test:all:
    desc: "Run all tests (backend + frontend unit + E2E)"
    cmds:
      - task: test:backend
      - task: test:frontend
      - task: test:e2e
  test:backend:
    desc: "Run backend tests with coverage"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "Running backend tests..."
      - uv run pytest --cov=zebu --cov-report=term --cov-report=html --cov-report=xml

  test:frontend:
    desc: "Run frontend unit tests (Vitest only)"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "Running frontend unit tests..."
      - npm run test:unit
    preconditions:
      - sh: test -f package.json
        msg: "Frontend not found. Run 'task setup:frontend' first."

  test:e2e:
    desc: "Run end-to-end tests with Playwright (pass args after --: task test:e2e -- --grep 'test name')"
    dir: "{{.FRONTEND_DIR}}"
    deps:
      - docker:up:all  # Ensure full stack is running
    env:
      # Load environment variables from .env file in repository root
      # These are required for Clerk authentication in E2E tests
      CLERK_SECRET_KEY:
        sh: grep "^CLERK_SECRET_KEY=" ../.env | cut -d= -f2- || echo ""
      CLERK_PUBLISHABLE_KEY:
        sh: grep "^CLERK_PUBLISHABLE_KEY=" ../.env | cut -d= -f2- || echo ""
      VITE_CLERK_PUBLISHABLE_KEY:
        sh: grep "^VITE_CLERK_PUBLISHABLE_KEY=" ../.env | cut -d= -f2- || echo ""
      E2E_CLERK_USER_EMAIL:
        sh: grep "^E2E_CLERK_USER_EMAIL=" ../.env | cut -d= -f2- || echo ""
    cmds:
      - echo "Running E2E tests..."
      - npm run test:e2e -- {{.CLI_ARGS}}
    preconditions:
      - sh: test -f package.json
        msg: "Frontend not found"

  test:e2e:ui:
    desc: "Run E2E tests with Playwright UI"
    dir: "{{.FRONTEND_DIR}}"
    deps:
      - docker:up:all  # Ensure full stack is running
    env:
      # Load environment variables from .env file in repository root
      CLERK_SECRET_KEY:
        sh: grep "^CLERK_SECRET_KEY=" ../.env | cut -d= -f2- || echo ""
      CLERK_PUBLISHABLE_KEY:
        sh: grep "^CLERK_PUBLISHABLE_KEY=" ../.env | cut -d= -f2- || echo ""
      VITE_CLERK_PUBLISHABLE_KEY:
        sh: grep "^VITE_CLERK_PUBLISHABLE_KEY=" ../.env | cut -d= -f2- || echo ""
      E2E_CLERK_USER_EMAIL:
        sh: grep "^E2E_CLERK_USER_EMAIL=" ../.env | cut -d= -f2- || echo ""
    cmds:
      - echo "Running E2E tests with UI..."
      - npm run test:e2e:ui
    preconditions:
      - sh: test -f package.json
        msg: "Frontend not found"

  lint:
    desc: "Run all linters (backend and frontend)"
    cmds:
      - task: lint:backend
      - task: lint:frontend

  lint:backend:
    desc: "Run backend linters (ruff, pyright)"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "Running ruff check..."
      - uv run ruff check .
      - echo "Running ruff format check..."
      - uv run ruff format --check .
      - echo "Running pyright..."
      - uv run pyright
      - echo "âœ“ Backend linting passed"

  lint:frontend:
    desc: "Run frontend linters (eslint, tsc)"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "Running ESLint..."
      - npm run lint
      - echo "Running TypeScript type check..."
      - npm run typecheck
      - echo "âœ“ Frontend linting passed"
    preconditions:
      - sh: test -f package.json
        msg: "Frontend not found. Run 'task setup:frontend' first."

  format:
    desc: "Auto-format all code"
    cmds:
      - task: format:backend
      - task: format:frontend

  format:backend:
    desc: "Auto-format backend code with ruff"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "Formatting backend code..."
      - uv run ruff format .
      - uv run ruff check --fix .
      - echo "âœ“ Backend code formatted"

  format:frontend:
    desc: "Auto-format frontend code"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "Formatting frontend code..."
      - npm run format
      - echo "âœ“ Frontend code formatted"
    preconditions:
      - sh: test -f package.json
        msg: "Frontend not found. Run 'task setup:frontend' first."

  docker:up:
    desc: "Start Docker services (PostgreSQL, Redis)"
    cmds:
      - docker compose up -d db redis
      - echo "âœ“ Docker services started"
      - 'echo "  - PostgreSQL: localhost:5432"'
      - 'echo "  - Redis: localhost:6379"'

  docker:up:all:
    desc: "Start all services in development mode (PostgreSQL, Redis, Backend, Frontend)"
    cmds:
      - docker compose up -d
      - echo "âœ“ All services started in development mode"
      - 'echo "  - PostgreSQL: localhost:5432"'
      - 'echo "  - Redis: localhost:6379"'
      - 'echo "  - Backend API: http://localhost:8000"'
      - 'echo "  - Frontend: http://localhost:5173"'
      - 'echo ""'
      - 'echo "View logs with: task docker:logs"'

  docker:build:
    desc: "Build all Docker images"
    cmds:
      - docker compose build
      - echo "âœ“ All Docker images built"

  docker:build:prod:
    desc: "Build production Docker images"
    cmds:
      - docker compose -f docker-compose.prod.yml build
      - echo "âœ“ Production Docker images built"

  docker:up:prod:
    desc: "Start all services in production mode"
    cmds:
      - docker compose -f docker-compose.prod.yml up -d
      - echo "âœ“ All services started in production mode"
      - 'echo "  - PostgreSQL: localhost:5432"'
      - 'echo "  - Redis: localhost:6379"'
      - 'echo "  - Backend API: http://localhost:8000"'
      - 'echo "  - Frontend: http://localhost:80"'

  docker:down:
    desc: "Stop Docker services"
    cmds:
      - docker compose down
      - echo "âœ“ Docker services stopped"

  docker:down:prod:
    desc: "Stop production Docker services"
    cmds:
      - docker compose -f docker-compose.prod.yml down
      - echo "âœ“ Production Docker services stopped"

  docker:logs:
    desc: "Show Docker service logs"
    cmds:
      - docker compose logs -f

  docker:logs:backend:
    desc: "Show backend logs"
    cmds:
      - docker compose logs -f backend

  docker:logs:frontend:
    desc: "Show frontend logs"
    cmds:
      - docker compose logs -f frontend

  docker:restart:
    desc: "Restart all Docker services"
    cmds:
      - docker compose restart
      - echo "âœ“ All services restarted"

  docker:restart:backend:
    desc: "Restart backend service"
    cmds:
      - docker compose restart backend
      - echo "âœ“ Backend service restarted"

  docker:restart:frontend:
    desc: "Restart frontend service"
    cmds:
      - docker compose restart frontend
      - echo "âœ“ Frontend service restarted"

  docker:clean:
    desc: "Stop and remove Docker volumes (WARNING: deletes all data)"
    cmds:
      - docker compose down -v
      - echo "âœ“ Docker services stopped and volumes removed"

  clean:
    desc: "Clean build artifacts and caches"
    cmds:
      - task: clean:backend
      - task: clean:frontend
      - echo "âœ“ Build artifacts and caches cleaned"

  clean:backend:
    desc: "Clean backend build artifacts and caches"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "Cleaning backend artifacts..."
      - rm -rf .pytest_cache .ruff_cache htmlcov .coverage
      - find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
      - echo "âœ“ Backend cleaned"

  clean:frontend:
    desc: "Clean frontend build artifacts and caches"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "Cleaning frontend artifacts..."
      - rm -rf node_modules/.cache dist coverage
      - echo "âœ“ Frontend cleaned"
    preconditions:
      - test -d {{.FRONTEND_DIR}}

  precommit:install:
    desc: "Install pre-commit hooks"
    cmds:
      - uv tool install pre-commit
      - uv tool run pre-commit install
      - echo "âœ“ Pre-commit hooks installed"

  precommit:run:
    desc: "Run pre-commit hooks on all files"
    cmds:
      - uv tool run pre-commit run --all-files

  build:
    desc: "Build all production artifacts"
    cmds:
      - task: build:backend
      - task: build:frontend

  build:backend:
    desc: "Build backend (check import structure, no syntax errors)"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "Checking backend imports and structure..."
      - uv run python -m compileall -q .
      - echo "âœ“ Backend build check passed"

  build:frontend:
    desc: "Build frontend for production"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "Building frontend..."
      - npm run build
      - echo "âœ“ Frontend built successfully"
    preconditions:
      - sh: test -f package.json
        msg: "Frontend not found. Run 'task setup:frontend' first."

  test:docker:dev:
    desc: "Test Docker development setup (health checks and connectivity)"
    cmds:
      - echo "Testing Docker development setup..."
      - task: docker:down
      - task: docker:clean
      - task: docker:up:all
      - sleep 15
      - echo "Checking service health..."
      - docker compose ps
      - echo "Testing backend health endpoint..."
      - curl -f http://localhost:8000/health || (echo "âŒ Backend health check failed" && exit 1)
      - echo "Testing frontend accessibility..."
      - curl -f http://localhost:5173/ || (echo "âŒ Frontend not accessible" && exit 1)
      - echo "âœ… Docker development setup working"
      - echo "Services are running. Use 'task docker:down' to stop them."

  test:docker:prod:
    desc: "Test Docker production setup (build and health checks)"
    cmds:
      - echo "Testing Docker production setup..."
      - task: docker:build:prod
      - docker compose -f docker-compose.prod.yml up -d
      - sleep 20
      - echo "Checking production service health..."
      - docker compose -f docker-compose.prod.yml ps
      - echo "Testing backend health endpoint..."
      - curl -f http://localhost:8000/health || (echo "âŒ Backend health check failed" && exit 1)
      - echo "Testing frontend accessibility..."
      - curl -f http://localhost:80/ || (echo "âŒ Frontend not accessible" && exit 1)
      - echo "âœ… Docker production setup working"
      - echo "Cleaning up production stack..."
      - docker compose -f docker-compose.prod.yml down
      - echo "âœ… Production test complete"

  # =========================================================================
  # Quality Checks (combined format + lint + test)
  # =========================================================================
  quality:backend:
    desc: "Run all backend quality checks (format, lint, test)"
    cmds:
      - task: format:backend
      - task: lint:backend
      - task: test:backend
      - echo "âœ“ All backend quality checks passed"

  quality:frontend:
    desc: "Run all frontend quality checks (format, lint, test)"
    cmds:
      - task: format:frontend
      - task: lint:frontend
      - task: test:frontend
      - echo "âœ“ All frontend quality checks passed"

  quality:
    desc: "Run all quality checks (backend and frontend)"
    cmds:
      - task: quality:backend
      - task: quality:frontend
      - echo "âœ“ All quality checks passed"

  # =========================================================================
  # CI Simulation (run locally to reproduce CI)
  # =========================================================================
  ci:
    desc: "Run full CI suite locally (matches GitHub Actions)"
    cmds:
      - echo "ðŸ”„ Running full CI suite..."
      - echo ""
      - task: ci:backend
      - task: ci:frontend
      - task: ci:e2e
      - echo ""
      - echo "âœ… All CI checks passed!"

  ci:backend:
    desc: "Run backend CI checks (quality checks only)"
    cmds:
      - echo "ðŸ”„ Running backend CI checks..."
      - task: quality:backend

  ci:frontend:
    desc: "Run frontend CI checks (quality checks only)"
    cmds:
      - echo "ðŸ”„ Running frontend CI checks..."
      - task: quality:frontend

  ci:e2e:
    desc: "Run E2E tests (requires Docker services)"
    deps:
      - docker:up:all
    cmds:
      - echo "ðŸ”„ Running E2E tests..."
      - task: health:wait
      - task: test:e2e

  # =========================================================================
  # Validation & Health Checks
  # =========================================================================
  validate:env:
    desc: "Validate development environment setup"
    cmds:
      - bash scripts/validate-environment.sh

  validate:secrets:
    desc: "Check that required secrets/env vars are set"
    cmds:
      - |
        echo "ðŸ” Checking secrets and environment variables..."
        echo ""
        MISSING=false

        # Check .env file exists
        if [ ! -f .env ]; then
          echo "  âŒ .env file not found"
          MISSING=true
        else
          echo "  âœ… .env file exists"
        fi

        # Source .env if it exists
        if [ -f .env ]; then
          set -a
          source .env 2>/dev/null || true
          set +a
        fi

        # Check critical secrets for E2E tests
        [ -n "$CLERK_SECRET_KEY" ] && echo "  âœ… CLERK_SECRET_KEY set" || (echo "  âš ï¸  CLERK_SECRET_KEY not set (E2E tests will fail)" && MISSING=true)
        [ -n "$CLERK_PUBLISHABLE_KEY" ] && echo "  âœ… CLERK_PUBLISHABLE_KEY set" || (echo "  âš ï¸  CLERK_PUBLISHABLE_KEY not set (E2E tests will fail)" && MISSING=true)
        [ -n "$VITE_CLERK_PUBLISHABLE_KEY" ] && echo "  âœ… VITE_CLERK_PUBLISHABLE_KEY set" || (echo "  âš ï¸  VITE_CLERK_PUBLISHABLE_KEY not set (E2E tests will fail)" && MISSING=true)
        [ -n "$E2E_CLERK_USER_EMAIL" ] && echo "  âœ… E2E_CLERK_USER_EMAIL: $E2E_CLERK_USER_EMAIL" || (echo "  âš ï¸  E2E_CLERK_USER_EMAIL not set (E2E tests will fail)" && MISSING=true)

        echo ""
        if [ "$MISSING" = true ]; then
          echo "âš ï¸  Some required secrets are missing. E2E tests may fail."
          echo "Copy .env.example to .env and fill in the values, or set environment variables."
        else
          echo "âœ… All required secrets are set"
        fi

  health:
    desc: "Check health of all running services"
    cmds:
      - |
        echo "ðŸ¥ Checking service health..."
        echo ""
        curl -f http://localhost:8000/health && echo "  âœ… Backend healthy" || echo "  âŒ Backend down"
        curl -f http://localhost:5173/ > /dev/null 2>&1 && echo "  âœ… Frontend healthy" || echo "  âŒ Frontend down"
        docker compose ps | grep -E "(db.*healthy|redis.*healthy)" > /dev/null 2>&1 && echo "  âœ… Docker services healthy" || echo "  âŒ Docker services down"

  health:all:
    desc: "Comprehensive health check (Docker + backend + frontend)"
    cmds:
      - task: health:docker
      - task: health:backend
      - task: health:frontend
      - echo ""
      - echo "âœ… All services healthy!"

  health:docker:
    desc: "Check Docker services are running and healthy"
    cmds:
      - |
        echo "ðŸ³ Checking Docker services..."
        if ! docker compose ps db 2>/dev/null | grep -q "Up"; then
          echo "  âŒ PostgreSQL not running"
          exit 1
        fi
        echo "  âœ… PostgreSQL running"

        if ! docker compose ps redis 2>/dev/null | grep -q "Up"; then
          echo "  âŒ Redis not running"
          exit 1
        fi
        echo "  âœ… Redis running"

  health:backend:
    desc: "Check backend API is responding"
    cmds:
      - |
        echo "ðŸ”§ Checking backend API..."
        if ! curl -f http://localhost:8000/health &> /dev/null; then
          echo "  âŒ Backend not responding at http://localhost:8000"
          exit 1
        fi
        echo "  âœ… Backend healthy at http://localhost:8000"

  health:frontend:
    desc: "Check frontend is responding"
    cmds:
      - |
        echo "ðŸŽ¨ Checking frontend..."
        if ! curl -f http://localhost:5173/ &> /dev/null; then
          echo "  âŒ Frontend not responding at http://localhost:5173"
          exit 1
        fi
        echo "  âœ… Frontend healthy at http://localhost:5173"

  health:wait:
    desc: "Wait for all services to be healthy (used in CI and before E2E tests)"
    cmds:
      - |
        echo "â³ Waiting for services to be ready..."

        # Wait for PostgreSQL
        echo "  Waiting for PostgreSQL..."
        timeout 30 bash -c 'until docker compose exec -T db pg_isready -U papertrade 2>/dev/null; do sleep 1; done' || (echo "  âŒ PostgreSQL timeout" && exit 1)
        echo "  âœ… PostgreSQL ready"

        # Wait for Redis
        echo "  Waiting for Redis..."
        timeout 30 bash -c 'until docker compose exec -T redis redis-cli ping 2>/dev/null | grep -q PONG; do sleep 1; done' || (echo "  âŒ Redis timeout" && exit 1)
        echo "  âœ… Redis ready"

        # Wait for Backend
        echo "  Waiting for backend..."
        timeout 60 bash -c 'until curl -f http://localhost:8000/health &>/dev/null; do sleep 2; done' || (echo "  âŒ Backend timeout" && exit 1)
        echo "  âœ… Backend ready"

        # Wait for Frontend
        echo "  Waiting for frontend..."
        timeout 60 bash -c 'until curl -f http://localhost:5173 &>/dev/null; do sleep 2; done' || (echo "  âŒ Frontend timeout" && exit 1)
        echo "  âœ… Frontend ready"

        echo ""
        echo "âœ… All services ready!"

  status:
    desc: "Show development environment status"
    cmds:
      - echo "ðŸ“Š Development Environment Status"
      - echo "=================================="
      - echo ""
      - echo "ðŸ“‚ Git Status:"
      - git status --short | head -10 || echo "  (clean)"
      - echo ""
      - echo "ðŸ³ Docker Services:"
      - docker compose ps
      - echo ""
      - echo "ðŸ”§ Running Servers:"
      - lsof -i:8000,5173,5432,6379 2>/dev/null || echo "  No servers running"
      - echo ""
      - echo "ðŸ“‹ Recent PRs:"
      - GH_PAGER="" gh pr list --limit 3 2>/dev/null || echo "  (gh not configured)"

  # =========================================================================
  # Database Management
  # =========================================================================
  db:reset:
    desc: "Reset database to clean state (WARNING: deletes all data)"
    cmds:
      - task: docker:down
      - task: docker:clean
      - task: docker:up
      - echo "âœ“ Database reset complete"

  db:shell:
    desc: "Open PostgreSQL shell"
    cmd: docker compose exec db psql -U papertrade -d papertrade_dev

  db:shell:prod:
    desc: "Open PostgreSQL shell (production database)"
    cmd: docker compose -f docker-compose.prod.yml exec db psql -U papertrade -d papertrade

  db:migrate:
    desc: "Run database migrations"
    dir: "{{.BACKEND_DIR}}"
    cmd: uv run alembic upgrade head

  db:migrate:create:
    desc: "Create a new database migration (usage: task db:migrate:create MESSAGE='description')"
    dir: "{{.BACKEND_DIR}}"
    cmd: uv run alembic revision --autogenerate -m "{{.MESSAGE}}"

  db:seed:
    desc: "Seed database with sample data"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - uv run python scripts/seed_db.py
      - echo "âœ“ Database seeded with sample data"

  db:seed:historical-data:
    desc: "Seed historical price data from Alpha Vantage (usage: task seed-historical-data -- --tickers AAPL,MSFT --days 365)"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - uv run python scripts/seed_historical_data.py {{.CLI_ARGS}}

  # =========================================================================
  # Proxmox VM Deployment
  # =========================================================================
  proxmox-vm:create:
    desc: "Create Docker VM on Proxmox"
    cmds:
      - bash scripts/proxmox-vm/create-vm.sh

  proxmox-vm:deploy:
    desc: "Deploy Zebu to Proxmox VM (use VERSION=v1.0.0 to deploy specific tag)"
    cmds:
      - bash scripts/proxmox-vm/deploy.sh

  proxmox-vm:status:
    desc: "Check deployment status"
    cmds:
      - bash scripts/proxmox-vm/lifecycle.sh status

  proxmox-vm:logs:
    desc: "View application logs"
    cmds:
      - bash scripts/proxmox-vm/lifecycle.sh logs

  proxmox-vm:start:
    desc: "Start services"
    cmds:
      - bash scripts/proxmox-vm/lifecycle.sh start

  proxmox-vm:stop:
    desc: "Stop services"
    cmds:
      - bash scripts/proxmox-vm/lifecycle.sh stop

  proxmox-vm:restart:
    desc: "Restart services"
    cmds:
      - bash scripts/proxmox-vm/lifecycle.sh restart

  proxmox-vm:destroy:
    desc: "Destroy VM (WARNING: destructive)"
    cmds:
      - bash scripts/proxmox-vm/destroy.sh
