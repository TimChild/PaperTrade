version: "3"

vars:
  BACKEND_DIR: ./backend
  FRONTEND_DIR: ./frontend

tasks:
  setup:
    desc: "Set up complete development environment"
    cmds:
      - task: precommit:install
      - task: setup:backend
      - task: setup:frontend
      - task: docker:up
      - echo "âœ“ Development environment setup complete!"
      - echo "  - Pre-commit hooks installed"
      - echo "  - Backend dependencies installed"
      - echo "  - Frontend dependencies installed (if frontend exists)"
      - echo "  - Docker services started (PostgreSQL, Redis)"
      - echo ""
      - 'echo "Next steps:"'
      - 'echo "  - Run ''task dev'' to start development servers"'
      - 'echo "  - Run ''task test'' to run all tests"'

  setup:backend:
    desc: "Install backend dependencies"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "Installing backend dependencies with uv..."
      - uv sync --all-extras
      - echo "âœ“ Backend dependencies installed"

  setup:frontend:
    desc: "Install frontend dependencies"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "Installing frontend dependencies with npm..."
      - npm ci
      - echo "âœ“ Frontend dependencies installed"
    status:
      - test -d node_modules

  dev:
    desc: "Start all development servers (docker services, backend, frontend)"
    deps:
      - docker:up
    cmds:
      - echo "Starting development servers..."
      - 'echo "Note: Run ''task dev:backend'' and ''task dev:frontend'' in separate terminals"'

  dev:backend:
    desc: "Start backend development server"
    dir: "{{.BACKEND_DIR}}"
    deps:
      - docker:up
    cmds:
      - 'echo "Starting backend server on http://localhost:8000"'
      - uv run uvicorn papertrade.main:app --reload --host 0.0.0.0 --port 8000

  dev:frontend:
    desc: "Start frontend development server"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "Starting frontend dev server..."
      - npm run dev
    preconditions:
      - sh: test -f package.json
        msg: "Frontend not found. Run 'task setup:frontend' first or create frontend directory."

  test:
    desc: "Run all tests (backend and frontend)"
    cmds:
      - task: test:backend
      - task: test:frontend

  test:backend:
    desc: "Run backend tests with coverage"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "Running backend tests..."
      - uv run pytest --cov=papertrade --cov-report=term --cov-report=html --cov-report=xml

  test:frontend:
    desc: "Run frontend unit tests (Vitest only)"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "Running frontend unit tests..."
      - npm run test:unit
    preconditions:
      - sh: test -f package.json
        msg: "Frontend not found. Run 'task setup:frontend' first."

  lint:
    desc: "Run all linters (backend and frontend)"
    cmds:
      - task: lint:backend
      - task: lint:frontend

  lint:backend:
    desc: "Run backend linters (ruff, pyright)"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "Running ruff check..."
      - uv run ruff check .
      - echo "Running ruff format check..."
      - uv run ruff format --check .
      - echo "Running pyright..."
      - uv run pyright
      - echo "âœ“ Backend linting passed"

  lint:frontend:
    desc: "Run frontend linters (eslint, tsc)"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "Running ESLint..."
      - npm run lint
      - echo "Running TypeScript type check..."
      - npm run typecheck
      - echo "âœ“ Frontend linting passed"
    preconditions:
      - sh: test -f package.json
        msg: "Frontend not found. Run 'task setup:frontend' first."

  format:
    desc: "Auto-format all code"
    cmds:
      - task: format:backend
      - task: format:frontend

  format:backend:
    desc: "Auto-format backend code with ruff"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "Formatting backend code..."
      - uv run ruff format .
      - uv run ruff check --fix .
      - echo "âœ“ Backend code formatted"

  format:frontend:
    desc: "Auto-format frontend code"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "Formatting frontend code..."
      - npm run format
      - echo "âœ“ Frontend code formatted"
    preconditions:
      - sh: test -f package.json
        msg: "Frontend not found. Run 'task setup:frontend' first."

  docker:up:
    desc: "Start Docker services (PostgreSQL, Redis)"
    cmds:
      - docker compose up -d db redis
      - echo "âœ“ Docker services started"
      - 'echo "  - PostgreSQL: localhost:5432"'
      - 'echo "  - Redis: localhost:6379"'

  docker:up:all:
    desc: "Start all services in development mode (PostgreSQL, Redis, Backend, Frontend)"
    cmds:
      - docker compose up -d
      - echo "âœ“ All services started in development mode"
      - 'echo "  - PostgreSQL: localhost:5432"'
      - 'echo "  - Redis: localhost:6379"'
      - 'echo "  - Backend API: http://localhost:8000"'
      - 'echo "  - Frontend: http://localhost:5173"'
      - 'echo ""'
      - 'echo "View logs with: task docker:logs"'

  docker:build:
    desc: "Build all Docker images"
    cmds:
      - docker compose build
      - echo "âœ“ All Docker images built"

  docker:build:prod:
    desc: "Build production Docker images"
    cmds:
      - docker compose -f docker-compose.prod.yml build
      - echo "âœ“ Production Docker images built"

  docker:up:prod:
    desc: "Start all services in production mode"
    cmds:
      - docker compose -f docker-compose.prod.yml up -d
      - echo "âœ“ All services started in production mode"
      - 'echo "  - PostgreSQL: localhost:5432"'
      - 'echo "  - Redis: localhost:6379"'
      - 'echo "  - Backend API: http://localhost:8000"'
      - 'echo "  - Frontend: http://localhost:80"'

  docker:down:
    desc: "Stop Docker services"
    cmds:
      - docker compose down
      - echo "âœ“ Docker services stopped"

  docker:down:prod:
    desc: "Stop production Docker services"
    cmds:
      - docker compose -f docker-compose.prod.yml down
      - echo "âœ“ Production Docker services stopped"

  docker:logs:
    desc: "Show Docker service logs"
    cmds:
      - docker compose logs -f

  docker:logs:backend:
    desc: "Show backend logs"
    cmds:
      - docker compose logs -f backend

  docker:logs:frontend:
    desc: "Show frontend logs"
    cmds:
      - docker compose logs -f frontend

  docker:restart:
    desc: "Restart all Docker services"
    cmds:
      - docker compose restart
      - echo "âœ“ All services restarted"

  docker:restart:backend:
    desc: "Restart backend service"
    cmds:
      - docker compose restart backend
      - echo "âœ“ Backend service restarted"

  docker:restart:frontend:
    desc: "Restart frontend service"
    cmds:
      - docker compose restart frontend
      - echo "âœ“ Frontend service restarted"

  docker:clean:
    desc: "Stop and remove Docker volumes (WARNING: deletes all data)"
    cmds:
      - docker compose down -v
      - echo "âœ“ Docker services stopped and volumes removed"

  clean:
    desc: "Clean build artifacts and caches"
    cmds:
      - task: clean:backend
      - task: clean:frontend
      - echo "âœ“ Build artifacts and caches cleaned"

  clean:backend:
    desc: "Clean backend build artifacts and caches"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "Cleaning backend artifacts..."
      - rm -rf .pytest_cache .ruff_cache htmlcov .coverage
      - find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
      - echo "âœ“ Backend cleaned"

  clean:frontend:
    desc: "Clean frontend build artifacts and caches"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "Cleaning frontend artifacts..."
      - rm -rf node_modules/.cache dist coverage
      - echo "âœ“ Frontend cleaned"
    preconditions:
      - test -d {{.FRONTEND_DIR}}

  precommit:install:
    desc: "Install pre-commit hooks"
    cmds:
      - uv tool install pre-commit
      - uv tool run pre-commit install
      - echo "âœ“ Pre-commit hooks installed"

  precommit:run:
    desc: "Run pre-commit hooks on all files"
    cmds:
      - uv tool run pre-commit run --all-files

  build:
    desc: "Build all production artifacts"
    cmds:
      - task: build:backend
      - task: build:frontend

  build:backend:
    desc: "Build backend (check import structure, no syntax errors)"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "Checking backend imports and structure..."
      - uv run python -m compileall -q .
      - echo "âœ“ Backend build check passed"

  build:frontend:
    desc: "Build frontend for production"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "Building frontend..."
      - npm run build
      - echo "âœ“ Frontend built successfully"
    preconditions:
      - sh: test -f package.json
        msg: "Frontend not found. Run 'task setup:frontend' first."

  test:e2e:
    desc: "Run end-to-end tests with Playwright"
    dir: "{{.FRONTEND_DIR}}"
    deps:
      - docker:up:all  # Ensure full stack is running
    env:
      # Load environment variables from .env file in repository root
      # These are required for Clerk authentication in E2E tests
      CLERK_SECRET_KEY:
        sh: grep "^CLERK_SECRET_KEY=" ../.env | cut -d= -f2- || echo ""
      CLERK_PUBLISHABLE_KEY:
        sh: grep "^CLERK_PUBLISHABLE_KEY=" ../.env | cut -d= -f2- || echo ""
      VITE_CLERK_PUBLISHABLE_KEY:
        sh: grep "^VITE_CLERK_PUBLISHABLE_KEY=" ../.env | cut -d= -f2- || echo ""
      E2E_CLERK_USER_EMAIL:
        sh: grep "^E2E_CLERK_USER_EMAIL=" ../.env | cut -d= -f2- || echo ""
    cmds:
      - echo "Running E2E tests..."
      - npm run test:e2e
    preconditions:
      - sh: test -f package.json
        msg: "Frontend not found"

  test:e2e:ui:
    desc: "Run E2E tests with Playwright UI"
    dir: "{{.FRONTEND_DIR}}"
    deps:
      - docker:up:all  # Ensure full stack is running
    env:
      # Load environment variables from .env file in repository root
      CLERK_SECRET_KEY:
        sh: grep "^CLERK_SECRET_KEY=" ../.env | cut -d= -f2- || echo ""
      CLERK_PUBLISHABLE_KEY:
        sh: grep "^CLERK_PUBLISHABLE_KEY=" ../.env | cut -d= -f2- || echo ""
      VITE_CLERK_PUBLISHABLE_KEY:
        sh: grep "^VITE_CLERK_PUBLISHABLE_KEY=" ../.env | cut -d= -f2- || echo ""
      E2E_CLERK_USER_EMAIL:
        sh: grep "^E2E_CLERK_USER_EMAIL=" ../.env | cut -d= -f2- || echo ""
    cmds:
      - echo "Running E2E tests with UI..."
      - npm run test:e2e:ui
    preconditions:
      - sh: test -f package.json
        msg: "Frontend not found"

  test:all:
    desc: "Run all tests (backend + frontend unit + E2E)"
    cmds:
      - task: test:backend
      - task: test:frontend
      - task: test:e2e

  test:docker:dev:
    desc: "Test Docker development setup (health checks and connectivity)"
    cmds:
      - echo "Testing Docker development setup..."
      - task: docker:down
      - task: docker:clean
      - task: docker:up:all
      - sleep 15
      - echo "Checking service health..."
      - docker compose ps
      - echo "Testing backend health endpoint..."
      - curl -f http://localhost:8000/health || (echo "âŒ Backend health check failed" && exit 1)
      - echo "Testing frontend accessibility..."
      - curl -f http://localhost:5173/ || (echo "âŒ Frontend not accessible" && exit 1)
      - echo "âœ… Docker development setup working"
      - echo "Services are running. Use 'task docker:down' to stop them."

  test:docker:prod:
    desc: "Test Docker production setup (build and health checks)"
    cmds:
      - echo "Testing Docker production setup..."
      - task: docker:build:prod
      - docker compose -f docker-compose.prod.yml up -d
      - sleep 20
      - echo "Checking production service health..."
      - docker compose -f docker-compose.prod.yml ps
      - echo "Testing backend health endpoint..."
      - curl -f http://localhost:8000/health || (echo "âŒ Backend health check failed" && exit 1)
      - echo "Testing frontend accessibility..."
      - curl -f http://localhost:80/ || (echo "âŒ Frontend not accessible" && exit 1)
      - echo "âœ… Docker production setup working"
      - echo "Cleaning up production stack..."
      - docker compose -f docker-compose.prod.yml down
      - echo "âœ… Production test complete"

  ci:
    desc: "Run all CI checks locally (same as GitHub Actions)"
    cmds:
      - task: lint
      - task: test
      - task: build
      - echo "âœ“ All CI checks passed!"

  ci:fast:
    desc: "Run fast CI checks (lint only, skip tests)"
    cmds:
      - task: lint
      - echo "âœ“ Fast checks passed. Run 'task ci' for full suite."

  # =========================================================================
  # Quick Status & Health Checks
  # =========================================================================
  health:
    desc: "Check health of all running services"
    cmds:
      - |
        echo "ðŸ¥ Checking service health..."
        echo ""
        curl -f http://localhost:8000/health && echo "  âœ… Backend healthy" || echo "  âŒ Backend down"
        curl -f http://localhost:5173/ > /dev/null 2>&1 && echo "  âœ… Frontend healthy" || echo "  âŒ Frontend down"
        docker compose ps | grep -E "(db.*healthy|redis.*healthy)" > /dev/null 2>&1 && echo "  âœ… Docker services healthy" || echo "  âŒ Docker services down"

  status:
    desc: "Show development environment status"
    cmds:
      - echo "ðŸ“Š Development Environment Status"
      - echo "=================================="
      - echo ""
      - echo "ðŸ“‚ Git Status:"
      - git status --short | head -10 || echo "  (clean)"
      - echo ""
      - echo "ðŸ³ Docker Services:"
      - docker compose ps
      - echo ""
      - echo "ðŸ”§ Running Servers:"
      - lsof -i:8000,5173,5432,6379 2>/dev/null || echo "  No servers running"
      - echo ""
      - echo "ðŸ“‹ Recent PRs:"
      - GH_PAGER="" gh pr list --limit 3 2>/dev/null || echo "  (gh not configured)"

  # =========================================================================
  # Database Management
  # =========================================================================
  db:reset:
    desc: "Reset database to clean state (WARNING: deletes all data)"
    cmds:
      - task: docker:down
      - task: docker:clean
      - task: docker:up
      - echo "âœ“ Database reset complete"

  db:shell:
    desc: "Open PostgreSQL shell"
    cmd: docker compose exec db psql -U papertrade -d papertrade_dev

  db:shell:prod:
    desc: "Open PostgreSQL shell (production database)"
    cmd: docker compose -f docker-compose.prod.yml exec db psql -U papertrade -d papertrade

  db:migrate:
    desc: "Run database migrations"
    dir: "{{.BACKEND_DIR}}"
    cmd: uv run alembic upgrade head

  db:migrate:create:
    desc: "Create a new database migration (usage: task db:migrate:create MESSAGE='description')"
    dir: "{{.BACKEND_DIR}}"
    cmd: uv run alembic revision --autogenerate -m "{{.MESSAGE}}"

  db:seed:
    desc: "Seed database with sample data"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - uv run python scripts/seed_db.py
      - echo "âœ“ Database seeded with sample data"

  seed-historical-data:
    desc: "Seed historical price data from Alpha Vantage (usage: task seed-historical-data -- --tickers AAPL,MSFT --days 365)"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - uv run python scripts/seed_historical_data.py {{.CLI_ARGS}}
